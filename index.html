<html ng-app>
<script src='angular.min.js'></script>
<meta charset='utf8'>
<div ng-controller='GeneCtrl'>
<table>
  <tr>
      <td>
          Самец:<br>
          <div  ng-repeat='v in genes'>
            {{v}}: <select ng-model='male[v]'>
               <option value=0>{{v}}{{v}}</option>
               <option value=1>{{v | uppercase}}{{v}}</option> 
               <option value=2>{{v | uppercase}}{{v | uppercase}}</option>   
              </select>                    
          </div>
      </td>
      <td>Самка:<br>
         <div  ng-repeat='v in genes'>
            {{v}}: <select ng-model='female[v]'>
               <option value=0>{{v}}{{v}}</option>
               <option value=1>{{v | uppercase}}{{v}}</option> 
               <option value=2>{{v | uppercase}}{{v | uppercase}}</option>   
              </select>                    
          </div>
          </td>            
  </tr>
</table>

  <hr>
  <div>Самец: {{gene_to_string(male)}}</div>
  <hr>
  <div>Самка: {{gene_to_string(female)}}</div>
  <hr>
  <button ng-click='calculate()'>Расчитать результаты</button>
  <hr>
  Возможных комбинаций генома: {{results.length}}

  <hr>
  <ul>
    <li ng-repeat="(k, v) in by_name">
    {{k}} : {{v}}
    </li>
  </ul>
</div>
<script>
  function Dog(){
    var r = {}
    var list = ['b', 'p', 'pd', 's', 'c', 't', 'w', 'r'] 
    for(i in list){
      r[list[i]] = 0
    }
    return r
  }
  function clone(obj){
    return JSON.parse(JSON.stringify(obj))
  }

  function cartesian() {
      var r = [], arg = arguments, max = arg.length-1;
      function helper(arr, i) {
          for (var j=0, l=arg[i].length; j<l; j++) {
              var a = arr.slice(0); // clone arr
              a.push(arg[i][j])
              if (i==max) {
                  r.push(a);
              } else
                  helper(a, i+1);
          }
      }
      helper([], 0);
      return r;
  };
  function GeneCtrl($scope){
    $scope.by_name = {}
    $scope.male = {}
    $scope.female = {}
    $scope.genes = ['b', 'p', 'pd', 's', 'c', 't', 'w', 'r']
    $scope.dominant = ['b', 'p', 'pd']
    $scope.recessive =  ['s', 'c', 't', 'w', 'r']
    $scope.results = []
    $scope.by_combo = []
    $scope.calculate = function(){
      var results = []
      var male = $scope.male
      var female = $scope.female

      var data = [];
      for(var ig in $scope.genes){
        var gene = $scope.genes[ig]
        if(male[gene] == '0')
          data.push([gene, gene])
        if(male[gene] == '1')
          data.push([gene.toUpperCase(), gene])
        if(male[gene] == '2')
          data.push([gene.toUpperCase(), gene.toUpperCase()])
        
        if(female[gene] == '0')
          data.push([gene, gene])
        if(female[gene] == '1')
          data.push([gene.toUpperCase(), gene])
        if(female[gene] == '2')
          data.push([gene.toUpperCase(), gene.toUpperCase()])
      }

      var all = cartesian.apply(this, data);
      var by_name = {}
      for(var iall in all){
        var key = all[iall].join("")
        if(by_name[key]){
          by_name[key]++
        }else{
          by_name[key] = 1
        }
      }
      $scope.by_name = by_name
      $scope.results = all
      $scope.$broadcast('results')
      $scope.$broadcast('by_name')
    }
    for(var i in $scope.genes){
      $scope.male = new Dog
      $scope.female = new Dog
    }
    
    $scope.gene_to_string = function(obj){
      var ret = ''
      for(var k in obj){
        if(k != '$$hashKey'){
          var v = parseInt(obj[k])
          if(v == 0)
            ret += k + k
          if(v == 1)
            ret += k.toUpperCase() + k
          if(v == 2)
            ret += k.toUpperCase() + k.toUpperCase()
          }
      }
      return ret
    }
  }
</script>
</html>
